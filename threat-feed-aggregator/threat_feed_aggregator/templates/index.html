{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
    <!-- jsVectorMap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/jsvectormap.min.css') }}">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        .stat-card { border: none; border-radius: var(--card-border-radius); transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .stat-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 0.75rem; background: rgba(255,255,255,0.2); font-size: 1.5rem; }
        .log-window { background-color: #0f172a; color: #38bdf8; font-family: 'Fira Code', monospace; border-radius: 0.75rem; padding: 1rem; font-size: 0.85rem; height: 300px; overflow-y: auto; border: 1px solid #1e293b; }
        .status-badge { font-weight: 700; text-transform: uppercase; font-size: 0.7rem; padding: 0.4em 0.8em; border-radius: 0.5rem; }
    </style>
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h3 class="fw-bold text-slate-800 mb-1">Operational Overview</h3>
            <p class="text-muted small">Comprehensive dashboard for threat feed management.</p>
        </div>
        <div class="col-md-6 text-md-end">
            <button class="btn btn-primary shadow-sm px-4 py-2" onclick="runAggregator()">
                <i class="fas fa-sync-alt me-2"></i> Run Aggregator Now
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white p-3 h-100 shadow-sm" style="background: var(--primary-gradient);">
                <div class="d-flex align-items-center"><div class="stat-icon"><i class="fas fa-list-ul"></i></div><div class="ms-3"><small class="opacity-75 text-uppercase fw-bold small">Total Indicators</small><h2 class="mb-0 fw-bold" id="stat-total">{{ total_indicator_count }}</h2></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-white p-3 h-100 shadow-sm border-0">
                <div class="d-flex align-items-center"><div class="stat-icon bg-soft-info text-info"><i class="fas fa-network-wired"></i></div><div class="ms-3"><small class="text-muted text-uppercase fw-bold small">IP Addresses</small><h2 class="mb-0 fw-bold text-dark" id="stat-ip">{{ indicator_counts_by_type.get('ip', 0) + indicator_counts_by_type.get('cidr', 0) }}</h2></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-white p-3 h-100 shadow-sm border-0">
                <div class="d-flex align-items-center"><div class="stat-icon bg-soft-warning text-warning"><i class="fas fa-globe"></i></div><div class="ms-3"><small class="text-muted text-uppercase fw-bold small">Domains & URLs</small><h2 class="mb-0 fw-bold text-dark" id="stat-domain">{{ indicator_counts_by_type.get('domain', 0) + indicator_counts_by_type.get('url', 0) }}</h2></div></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-white p-3 h-100 shadow-sm border-0">
                <div class="d-flex align-items-center"><div class="stat-icon bg-soft-success text-success"><i class="fas fa-rss"></i></div><div class="ms-3"><small class="text-muted text-uppercase fw-bold small">Active Feeds</small><h2 class="mb-0 fw-bold text-dark" id="stat-feeds">{{ urls|length }}</h2></div></div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Active Sources Management -->
        <div class="col-md-8">
            <div class="card settings-card shadow-sm h-100 border-0">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-rss-square me-2 text-primary"></i>Active Threat Feed Sources</h6>
                    <button class="btn btn-sm btn-primary px-3" onclick="showAddSourceModal()"><i class="fas fa-plus me-1"></i> Add Source</button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr class="small text-muted"><th class="ps-4">Source Name</th><th>Indicators</th><th>Last Update</th><th class="text-end pe-4">Actions</th></tr></thead>
                            <tbody class="small">
                                {% for source in urls %}
                                {% set source_stat = stats.get(source.name, {}) %}
                                <tr>
                                    <td class="ps-4 py-3"><strong>{{ source.name }}</strong><br><small class="text-muted">{{ source.url }}</small></td>
                                    <td><span class="badge bg-primary px-2">{{ source_stat.get('count', 0) }}</span></td>
                                    <td>{{ source_stat.get('last_updated', 'N/A') }}</td>
                                    <td class="text-end pe-4">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-success" onclick="runSingleSource('{{ source.name }}')" title="Fetch Now"><i class="fas fa-play"></i></button>
                                            <button class="btn btn-sm btn-outline-info" onclick="testSource('{{ source.name }}')" title="Test"><i class="fas fa-vial"></i></button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick='showEditSourceModal({{ loop.index0 }}, {{ source|tojson }})' title="Config"><i class="fas fa-cog"></i></button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

                    <!-- Side Tools -->

                    <div class="col-md-4">

                        <div class="card settings-card shadow-sm mb-4 border-0">

                            <div class="card-header bg-white py-3 border-0"><h6 class="fw-bold mb-0 text-dark"><i class="fas fa-file-export me-2 text-warning"></i>Output Lists (EDL)</h6></div>

                            <div class="card-body pt-0">

                                <div class="mb-3">

                                    <label class="small text-muted mb-1 fw-bold">Palo Alto Networks</label>

                                    <div class="btn-group w-100 mb-2">

                                        <a href="{{ url_for('dashboard.download_file', filename='palo_alto_ip.txt') }}" class="btn btn-outline-dark btn-sm w-50"><i class="fas fa-network-wired me-1"></i>IP List</a>

                                        <a href="{{ url_for('dashboard.download_file', filename='palo_alto_domain.txt') }}" class="btn btn-outline-dark btn-sm w-50"><i class="fas fa-globe me-1"></i>Domain List</a>

                                    </div>

                                    

                                    <label class="small text-muted mb-1 fw-bold">Fortinet FortiGate</label>

                                    <div class="btn-group w-100">

                                        <a href="{{ url_for('dashboard.download_file', filename='fortinet_ip.txt') }}" class="btn btn-outline-dark btn-sm w-50"><i class="fas fa-network-wired me-1"></i>IP List</a>

                                        <a href="{{ url_for('dashboard.download_file', filename='fortinet_domain.txt') }}" class="btn btn-outline-dark btn-sm w-50"><i class="fas fa-globe me-1"></i>Domain List</a>

                                    </div>

                                </div>

                                <h6 class="form-label-custom small fw-bold mb-2">Custom EDL Manager</h6>

        
                    <div class="card border mb-3">
                        <div class="card-header bg-light p-1">
                            <ul class="nav nav-tabs card-header-tabs m-0 small" id="edlTabs" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active py-1 px-2" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved" type="button" role="tab">Saved Lists</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link py-1 px-2" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab">Create New</button></li>
                            </ul>
                        </div>
                        <div class="card-body p-2">
                            <div class="tab-content" id="edlTabsContent">
                                <!-- Saved Lists Tab -->
                                <div class="tab-pane fade show active" id="saved" role="tabpanel">
                                    {% if custom_lists %}
                                        <div class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;">
                                            {% for list in custom_lists %}
                                            <div class="list-group-item px-0 py-2">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <strong class="text-truncate" title="{{ list.name }}">{{ list.name }}</strong>
                                                    <form action="{{ url_for('system.remove_custom_list_route') }}" method="POST" class="d-inline" onsubmit="return confirm('Delete this list?');">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <input type="hidden" name="list_id" value="{{ list.id }}">
                                                        <button type="submit" class="btn btn-link text-danger p-0" title="Delete"><i class="fas fa-trash-alt"></i></button>
                                                    </form>
                                                </div>
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control" style="font-size: 0.7rem;" value="{{ url_for('api.get_saved_custom_edl', token=list.token, _external=True) }}" readonly id="list_url_{{ list.id }}">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('list_url_{{ list.id }}')"><i class="fas fa-copy"></i></button>
                                                </div>
                                                <div class="mt-1 text-muted" style="font-size: 0.65rem;">
                                                    Fmt: {{ list.format }} | Src: {{ list.sources|length }} | Items: <span class="list-count" data-id="{{ list.id }}">...</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-center text-muted small my-3">No custom lists saved.</p>
                                    {% endif %}
                                </div>

                                <!-- Create New Tab -->
                                <div class="tab-pane fade" id="create" role="tabpanel">
                                    <form action="{{ url_for('system.add_custom_list_route') }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" name="name" placeholder="List Name (e.g. High Risk IPs)" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="small text-muted mb-1">Content Type</label><br>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="content_type" id="type_ip" value="ip" checked>
                                                <label class="btn btn-outline-primary btn-xs" for="type_ip">IP/CIDR</label>
                                                
                                                <input type="radio" class="btn-check" name="content_type" id="type_domain" value="domain">
                                                <label class="btn btn-outline-primary btn-xs" for="type_domain">Domain</label>
                                                
                                                <input type="radio" class="btn-check" name="content_type" id="type_url" value="url">
                                                <label class="btn btn-outline-primary btn-xs" for="type_url">URL</label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <label class="small text-muted mb-0">Sources</label>
                                                <a href="#" onclick="toggleAllSources(); return false;" class="small text-decoration-none" style="font-size: 0.7rem;">Toggle All</a>
                                            </div>
                                            <div class="bg-white border rounded p-2" style="max-height: 120px; overflow-y: auto;" id="edl_sources_list">
                                                <!-- Sources populated by JS -->
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="small text-muted mb-1">Format</label>
                                            <select name="format" class="form-select form-select-sm">
                                                <option value="text">Plain Text</option>
                                                <option value="csv">CSV</option>
                                                <option value="json">JSON</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm w-100"><i class="fas fa-save me-1"></i> Save Custom List</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h6 class="form-label-custom small fw-bold mb-2">Service Whitelists</h6>
                    <div class="d-flex flex-column gap-2">
                        <!-- MS365 -->
                        <div class="btn-group w-100 d-flex">
                            <button onclick="updateMS365()" class="btn btn-light btn-sm text-start border flex-grow-1 text-truncate"><i class="fab fa-microsoft me-2 text-info"></i>Update MS365</button>
                            <button type="button" class="btn btn-light btn-sm border dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" style="flex: 0 0 auto;"><span class="visually-hidden">Toggle Dropdown</span></button>
                            <ul class="dropdown-menu shadow border-0">
                                <li><h6 class="dropdown-header small text-uppercase">Common</h6></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_common_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_common_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header small text-uppercase">Exchange</h6></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_exchange_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_exchange_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header small text-uppercase">SharePoint</h6></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_sharepoint_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_sharepoint_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header small text-uppercase">Skype/Teams</h6></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_skype_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_skype_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                            </ul>
                        </div>

                        <!-- GitHub -->
                        <div class="btn-group w-100 d-flex">
                            <button onclick="updateGitHub()" class="btn btn-light btn-sm text-start border flex-grow-1 text-truncate"><i class="fab fa-github me-2 text-dark"></i>Update GitHub</button>
                            <button type="button" class="btn btn-light btn-sm border dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" style="flex: 0 0 auto;"><span class="visually-hidden">Toggle Dropdown</span></button>
                            <ul class="dropdown-menu shadow border-0">
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_git_ips.txt') }}">Git Operations</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_web_ips.txt') }}">Web Access</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_actions_ips.txt') }}">Actions Runners</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_hooks_ips.txt') }}">Webhooks</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_pages_ips.txt') }}">Pages</a></li>
                            </ul>
                        </div>

                        <!-- Azure -->
                        <div class="btn-group w-100 d-flex">
                            <button onclick="updateAzure()" class="btn btn-light btn-sm text-start border flex-grow-1 text-truncate"><i class="fas fa-cloud me-2 text-primary"></i>Update Azure</button>
                            <button type="button" class="btn btn-light btn-sm border dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" style="flex: 0 0 auto;"><span class="visually-hidden">Toggle Dropdown</span></button>
                            <ul class="dropdown-menu shadow border-0">
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_all_ips.txt') }}">All Public IPs</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header small text-uppercase">Services</h6></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_sql_ips.txt') }}">Azure SQL</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_storage_ips.txt') }}">Azure Storage</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header small text-uppercase">Regions</h6></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_westeurope_ips.txt') }}">West Europe</a></li>
                                <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_northeurope_ips.txt') }}">North Europe</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card settings-card shadow-sm border-0 border-start border-4 border-success">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-shield-alt me-2 text-success"></i>Safe List</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-xs btn-outline-success" onclick="showImportWhitelistModal()" title="Import TXT/JSON/XML"><i class="fas fa-file-import"></i></button>
                        <button class="btn btn-xs btn-outline-success" data-bs-toggle="modal" data-bs-target="#safeListModal">View All</button>
                        <button class="btn btn-xs btn-success" onclick="showAddWhitelistModal()">Add</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 180px;"><table class="table table-sm mb-0 align-middle">
                        <tbody class="small">{% if whitelist %}{% for item in whitelist[:5] %}<tr><td class="ps-3 py-2"><code class="text-success">{{ item.item }}</code></td><td class="text-end pe-3"><a href="{{ url_for('system.remove_whitelist', item_id=item.id) }}" class="text-danger" onclick="return confirm('Remove?')"><i class="fas fa-times-circle"></i></a></td></tr>{% endfor %}{% else %}<tr><td class="text-center py-3 text-muted">Empty.</td></tr>{% endif %}</tbody>
                    </table></div>
                </div>
            </div>

            <div class="card settings-card shadow-sm border-0 border-start border-4 border-danger mt-4">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-ban me-2 text-danger"></i>Block List</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-xs btn-outline-danger" onclick="showImportBlacklistModal()" title="Import TXT/JSON/XML"><i class="fas fa-file-import"></i></button>
                        <button class="btn btn-xs btn-outline-danger" data-bs-toggle="modal" data-bs-target="#blockListModal">View All</button>
                        <button class="btn btn-xs btn-danger" onclick="showAddBlacklistModal()">Add</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 180px;"><table class="table table-sm mb-0 align-middle">
                        <tbody class="small">{% if blacklist %}{% for item in blacklist[:5] %}<tr><td class="ps-3 py-2"><code class="text-danger">{{ item.item }}</code><br><small class="text-muted" style="font-size: 0.65em;">{{ item.comment }}</small></td><td class="text-end pe-3"><a href="{{ url_for('system.remove_blacklist', item_val=item.item) }}" class="text-secondary" onclick="return confirm('Remove?')"><i class="fas fa-times-circle"></i></a></td></tr>{% endfor %}{% else %}<tr><td class="text-center py-3 text-muted">Empty.</td></tr>{% endif %}</tbody>
                    </table></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Safe List Modal -->
    <div class="modal fade" id="safeListModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                <div class="modal-header border-0 bg-light py-3">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-shield-alt me-2 text-success"></i>Full Safe List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr class="small text-muted"><th class="ps-4">Item</th><th class="text-end pe-4">Action</th></tr></thead>
                            <tbody class="small">
                                {% if whitelist %}
                                    {% for item in whitelist %}
                                    <tr>
                                        <td class="ps-4 py-2"><code class="text-success">{{ item.item }}</code><br><small class="text-muted">{{ item.description }}</small></td>
                                        <td class="text-end pe-4">
                                            <a href="{{ url_for('system.remove_whitelist', item_id=item.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove?')"><i class="fas fa-trash"></i></a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="2" class="text-center py-3 text-muted">Empty.</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0"><button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>

    <!-- Block List Modal -->
    <div class="modal fade" id="blockListModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                <div class="modal-header border-0 bg-light py-3">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-ban me-2 text-danger"></i>Full Block List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr class="small text-muted"><th class="ps-4">Item</th><th class="text-end pe-4">Action</th></tr></thead>
                            <tbody class="small">
                                {% if blacklist %}
                                    {% for item in blacklist %}
                                    <tr>
                                        <td class="ps-4 py-2"><code class="text-danger">{{ item.item }}</code><br><small class="text-muted">{{ item.comment }}</small></td>
                                        <td class="text-end pe-4">
                                            <a href="{{ url_for('system.remove_blacklist', item_val=item.item) }}" class="btn btn-sm btn-outline-secondary" onclick="return confirm('Remove?')"><i class="fas fa-trash"></i></a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="2" class="text-center py-3 text-muted">Empty.</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0"><button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>

    <!-- Task Activity & Schedules -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card settings-card shadow-sm h-100 border-0">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-history me-2 text-secondary"></i>Recent Task Activity</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-xs btn-outline-primary" onclick="viewAllHistory()">View All</button>
                        <button class="btn btn-xs btn-outline-danger" onclick="clearHistory()">Clear History</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive"><table class="table table-sm table-hover mb-0 align-middle">
                        <thead class="table-light"><tr class="small text-muted"><th class="ps-4">Timestamp</th><th>Source</th><th>Status</th><th>Items</th><th class="text-end pe-4">Message</th></tr></thead>
                        <tbody id="historyTableBody" class="small"><tr><td colspan="5" class="text-center py-3">Loading...</td></tr></tbody>
                    </table></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card settings-card shadow-sm h-100 border-0">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-calendar-alt me-2 text-info"></i>Scheduled Runs</h6>
                    <button class="btn btn-xs btn-outline-primary" onclick="viewAllSchedules()">View All</button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive"><table class="table table-sm mb-0 align-middle">
                        <tbody id="scheduledJobsTableBody" class="small">
                            <!-- Populated by JS -->
                        </tbody>
                    </table></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedules Modal -->
    <div class="modal fade" id="schedulesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                <div class="modal-header border-0 bg-light py-3">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-calendar-alt me-2 text-info"></i>All Scheduled Tasks</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr class="small text-muted">
                                    <th class="ps-4">Task Name</th>
                                    <th>Exact Time</th>
                                    <th class="text-end pe-4">Remaining</th>
                                </tr>
                            </thead>
                            <tbody id="allSchedulesTableBody" class="small">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                <div class="modal-header border-0 bg-light py-3">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-history me-2 text-primary"></i>Full Task History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr class="small text-muted">
                                    <th class="ps-4">Timestamp</th>
                                    <th>Source</th>
                                    <th>Status</th>
                                    <th>Items</th>
                                    <th class="text-end pe-4">Message</th>
                                </tr>
                            </thead>
                            <tbody id="fullHistoryTableBody" class="small">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map & Terminal -->
    <div class="row g-4 mb-4">
        <div class="col-md-12"><div class="card settings-card shadow-sm border-0">
            <div class="card-header bg-white py-3 border-0"><h6 class="fw-bold mb-0 text-dark"><i class="fas fa-globe-americas me-2 text-primary"></i>Global Threat Distribution</h6></div>
            <div class="card-body"><div class="row"><div class="col-md-9"><div id="world-map" style="height: 400px; width: 100%;" class="border rounded-3 bg-light"></div></div><div class="col-md-3">
                <table class="table table-sm border-0"><thead class="border-0"><tr class="small text-muted border-0"><th class="border-0">Country</th><th class="text-end border-0">Count</th></tr></thead>
                <tbody id="countryStatsTableBody">{% for country in country_stats %}<tr><td class="small py-2">{{ country.country_code }}</td><td class="text-end small py-2 fw-bold text-primary">{{ country.count }}</td></tr>{% endfor %}</tbody></table>
            </div></div></div>
        </div></div>
        <div class="col-md-12"><div class="card settings-card shadow-sm border-0">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-terminal me-2 text-info"></i>Live Operational Logs</h6>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0"><input class="form-check-input" type="checkbox" id="hidePolls" checked onchange="updateLogs()"><label class="form-check-label small text-muted" for="hidePolls">Hide Polls</label></div>
                    <button class="btn btn-xs btn-outline-secondary" onclick="clearTerminal()">Clear</button>
                </div>
            </div>
            <div class="card-body pt-0"><div id="logWindow" class="log-window"></div></div>
        </div></div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <!-- jsVectorMap -->
    <script src="{{ url_for('static', filename='vendor/js/jsvectormap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/world.js') }}"></script>
    
    <script>
        window.AppConfig = {
            urls: {
                addSource: "{{ url_for('system.add_source') }}",
                addWhitelist: "{{ url_for('system.add_whitelist') }}",
                addBlacklist: "{{ url_for('system.add_blacklist') }}" 
            },
            sourceUrls: {{ urls|tojson }},
            csrfToken: "{{ csrf_token() }}",
            flashMessages: {{ get_flashed_messages(with_categories=true)|tojson }},
            countryStats: {
                {% for c in country_stats %}
                "{{ c.country_code }}": {{ c.count }},
                {% endfor %}
            }
        };

        // Fetch Custom List Counts
        document.addEventListener('DOMContentLoaded', function() {
            const counters = document.querySelectorAll('.list-count');
            counters.forEach(span => {
                const id = span.getAttribute('data-id');
                fetch(`/api/custom_list/count/${id}`)
                    .then(r => r.json())
                    .then(data => { span.textContent = data.count; })
                    .catch(() => { span.textContent = '?'; });
            });
        });
    </script>
    <script src="{{ url_for('static', filename='js/dashboard.js', v=2) }}"></script>
{% endblock %}