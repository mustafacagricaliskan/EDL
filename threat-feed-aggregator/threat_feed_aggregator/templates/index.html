<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Threat Feed Aggregator</title>
    <!-- Bootstrap 5 -->
    <link href="{{ url_for('static', filename='vendor/css/bootstrap.min.css') }}" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="{{ url_for('static', filename='vendor/css/fontawesome.min.css') }}" rel="stylesheet">
    <!-- jsVectorMap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/jsvectormap.min.css') }}">
    <!-- Theme CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --secondary-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --card-border-radius: 1rem;
        }
        body { background-color: #f8fafc; }
        .stat-card { border: none; border-radius: var(--card-border-radius); transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .stat-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 0.75rem; background: rgba(255,255,255,0.2); font-size: 1.5rem; }
        .log-window { background-color: #0f172a; color: #38bdf8; font-family: 'Fira Code', monospace; border-radius: 0.75rem; padding: 1rem; font-size: 0.85rem; height: 300px; overflow-y: auto; border: 1px solid #1e293b; }
        .sidebar { background: var(--secondary-gradient); position: fixed; height: 100vh; width: 260px; z-index: 1000; }
        .sidebar a { color: rgba(255,255,255,0.7); text-decoration: none; padding: 0.85rem 1.5rem; display: flex; align-items: center; transition: all 0.2s; border-left: 4px solid transparent; }
        .sidebar a:hover { color: white; background: rgba(255,255,255,0.05); }
        .sidebar a.active { color: white; background: rgba(255,255,255,0.1); border-left: 4px solid #38bdf8; font-weight: 600; }
        .sidebar a i { width: 24px; margin-right: 10px; }
        .content { margin-left: 260px; padding: 2.5rem; min-height: 100vh; }
        .status-badge { font-weight: 700; text-transform: uppercase; font-size: 0.7rem; padding: 0.4em 0.8em; border-radius: 0.5rem; }
        .form-label-custom { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column">
        <div class="px-4 py-4 mb-2">
            <h4 class="text-white fw-bold mb-0"><i class="fas fa-shield-virus me-2 text-info"></i> ThreatFeed</h4>
            <small class="text-info opacity-75">Intelligence Engine</small>
        </div>
        <a href="{{ url_for('dashboard.index') }}" class="active"><i class="fas fa-th-large"></i> Overview</a>
        <a href="{{ url_for('tools.investigate') }}"><i class="fas fa-search-location"></i> IP Investigation</a>
        <a href="{{ url_for('system.index') }}"><i class="fas fa-cog"></i> System Settings</a>
        <div class="mt-auto p-4 border-top border-secondary">
            <div class="d-flex align-items-center mb-3">
                <div class="avatar-sm bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width:32px; height:32px; font-size: 0.8rem;">
                    {{ session.get('username', 'U')[0]|upper }}
                </div>
                <div class="small overflow-hidden">
                    <div class="text-white fw-bold text-truncate">{{ session.get('username') }}</div>
                    <div class="text-muted text-truncate" style="font-size:0.7rem;">{{ session.get('profile_name', 'Analyst') }}</div>
                </div>
            </div>
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger btn-sm w-100 py-2 border-0 text-start p-0"><i class="fas fa-sign-out-alt me-2"></i> Sign Out</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <!-- Header -->
        <div class="row align-items-center mb-4">
            <div class="col-md-6">
                <h3 class="fw-bold text-slate-800 mb-1">Operational Overview</h3>
                <p class="text-muted small">Comprehensive dashboard for threat feed management.</p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-primary shadow-sm px-4 py-2" onclick="runAggregator()">
                    <i class="fas fa-sync-alt me-2"></i> Run Aggregator Now
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card stat-card bg-primary text-white p-3 h-100 shadow-sm" style="background: var(--primary-gradient);">
                    <div class="d-flex align-items-center"><div class="stat-icon"><i class="fas fa-list-ul"></i></div><div class="ms-3"><small class="opacity-75 text-uppercase fw-bold small">Total Indicators</small><h2 class="mb-0 fw-bold" id="stat-total">{{ total_indicator_count }}</h2></div></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-white p-3 h-100 shadow-sm border-0">
                    <div class="d-flex align-items-center"><div class="stat-icon bg-soft-info text-info"><i class="fas fa-network-wired"></i></div><div class="ms-3"><small class="text-muted text-uppercase fw-bold small">IP Addresses</small><h2 class="mb-0 fw-bold text-dark" id="stat-ip">{{ indicator_counts_by_type.get('ip', 0) + indicator_counts_by_type.get('cidr', 0) }}</h2></div></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-white p-3 h-100 shadow-sm border-0">
                    <div class="d-flex align-items-center"><div class="stat-icon bg-soft-warning text-warning"><i class="fas fa-globe"></i></div><div class="ms-3"><small class="text-muted text-uppercase fw-bold small">Domains & URLs</small><h2 class="mb-0 fw-bold text-dark" id="stat-domain">{{ indicator_counts_by_type.get('domain', 0) + indicator_counts_by_type.get('url', 0) }}</h2></div></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-white p-3 h-100 shadow-sm border-0">
                    <div class="d-flex align-items-center"><div class="stat-icon bg-soft-success text-success"><i class="fas fa-rss"></i></div><div class="ms-3"><small class="text-muted text-uppercase fw-bold small">Active Feeds</small><h2 class="mb-0 fw-bold text-dark" id="stat-feeds">{{ urls|length }}</h2></div></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <!-- Active Sources Management -->
            <div class="col-md-8">
                <div class="card settings-card shadow-sm h-100 border-0">
                    <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-rss-square me-2 text-primary"></i>Active Threat Feed Sources</h6>
                        <button class="btn btn-sm btn-primary px-3" onclick="showAddSourceModal()"><i class="fas fa-plus me-1"></i> Add Source</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="table-light"><tr class="small text-muted"><th class="ps-4">Source Name</th><th>Indicators</th><th>Last Update</th><th class="text-end pe-4">Actions</th></tr></thead>
                                <tbody class="small">
                                    {% for source in urls %}
                                    {% set source_stat = stats.get(source.name, {}) %}
                                    <tr>
                                        <td class="ps-4 py-3"><strong>{{ source.name }}</strong><br><small class="text-muted">{{ source.url }}</small></td>
                                        <td><span class="badge bg-primary px-2">{{ source_stat.get('count', 0) }}</span></td>
                                        <td>{{ source_stat.get('last_updated', 'N/A') }}</td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-success" onclick="runSingleSource('{{ source.name }}')" title="Fetch Now"><i class="fas fa-play"></i></button>
                                                <button class="btn btn-sm btn-outline-info" onclick="testSource('{{ source.name }}')" title="Test"><i class="fas fa-vial"></i></button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick='showEditSourceModal({{ loop.index0 }}, {{ source|tojson }})' title="Config"><i class="fas fa-cog"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Side Tools -->
            <div class="col-md-4">
                <div class="card settings-card shadow-sm mb-4 border-0">
                    <div class="card-header bg-white py-3 border-0"><h6 class="fw-bold mb-0 text-dark"><i class="fas fa-file-export me-2 text-warning"></i>Output Lists (EDL)</h6></div>
                    <div class="card-body pt-0">
                        <div class="d-grid gap-2 mb-3">
                            <a href="{{ url_for('dashboard.download_file', filename='palo_alto_edl.txt') }}" class="btn btn-outline-dark text-start p-2 small d-flex justify-content-between"><span>Palo Alto Networks</span><i class="fas fa-download"></i></a>
                            <a href="{{ url_for('dashboard.download_file', filename='fortinet_edl.txt') }}" class="btn btn-outline-dark text-start p-2 small d-flex justify-content-between"><span>Fortinet FortiGate</span><i class="fas fa-download"></i></a>
                        </div>
                        <h6 class="form-label-custom small fw-bold mb-2">Service Whitelists</h6>
                        <div class="d-flex flex-column gap-2">
                            <!-- MS365 -->
                            <div class="btn-group w-100 d-flex">
                                <button onclick="updateMS365()" class="btn btn-light btn-sm text-start border flex-grow-1 text-truncate"><i class="fab fa-microsoft me-2 text-info"></i>Update MS365</button>
                                <button type="button" class="btn btn-light btn-sm border dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" style="flex: 0 0 auto;"><span class="visually-hidden">Toggle Dropdown</span></button>
                                <ul class="dropdown-menu shadow border-0">
                                    <li><h6 class="dropdown-header small text-uppercase">Common</h6></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_common_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_common_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header small text-uppercase">Exchange</h6></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_exchange_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_exchange_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header small text-uppercase">SharePoint</h6></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_sharepoint_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_sharepoint_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header small text-uppercase">Skype/Teams</h6></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_skype_ips.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>IPs</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='ms365_skype_urls.txt') }}"><i class="fas fa-download me-2 text-secondary"></i>URLs</a></li>
                                </ul>
                            </div>

                            <!-- GitHub -->
                            <div class="btn-group w-100 d-flex">
                                <button onclick="updateGitHub()" class="btn btn-light btn-sm text-start border flex-grow-1 text-truncate"><i class="fab fa-github me-2 text-dark"></i>Update GitHub</button>
                                <button type="button" class="btn btn-light btn-sm border dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" style="flex: 0 0 auto;"><span class="visually-hidden">Toggle Dropdown</span></button>
                                <ul class="dropdown-menu shadow border-0">
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_git_ips.txt') }}">Git Operations</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_web_ips.txt') }}">Web Access</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_actions_ips.txt') }}">Actions Runners</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_hooks_ips.txt') }}">Webhooks</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='github_pages_ips.txt') }}">Pages</a></li>
                                </ul>
                            </div>

                            <!-- Azure -->
                            <div class="btn-group w-100 d-flex">
                                <button onclick="updateAzure()" class="btn btn-light btn-sm text-start border flex-grow-1 text-truncate"><i class="fas fa-cloud me-2 text-primary"></i>Update Azure</button>
                                <button type="button" class="btn btn-light btn-sm border dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" style="flex: 0 0 auto;"><span class="visually-hidden">Toggle Dropdown</span></button>
                                <ul class="dropdown-menu shadow border-0">
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_all_ips.txt') }}">All Public IPs</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header small text-uppercase">Services</h6></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_sql_ips.txt') }}">Azure SQL</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_storage_ips.txt') }}">Azure Storage</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header small text-uppercase">Regions</h6></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_westeurope_ips.txt') }}">West Europe</a></li>
                                    <li><a class="dropdown-item small" href="{{ url_for('dashboard.download_file', filename='azure_northeurope_ips.txt') }}">North Europe</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card settings-card shadow-sm border-0 border-start border-4 border-success">
                    <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-check-shield me-2 text-success"></i>Safe List</h6>
                        <button class="btn btn-xs btn-success" onclick="showAddWhitelistModal()">Add</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 180px;"><table class="table table-sm mb-0 align-middle">
                            <tbody class="small">{% if whitelist %}{% for item in whitelist %}<tr><td class="ps-3 py-2"><code class="text-success">{{ item.item }}</code></td><td class="text-end pe-3"><a href="{{ url_for('system.remove_whitelist', item_id=item.id) }}" class="text-danger" onclick="return confirm('Remove?')"><i class="fas fa-times-circle"></i></a></td></tr>{% endfor %}{% else %}<tr><td class="text-center py-3 text-muted">Empty.</td></tr>{% endif %}</tbody>
                        </table></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Activity & Schedules -->
        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="card settings-card shadow-sm border-0">
                    <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-history me-2 text-secondary"></i>Recent Task Activity</h6>
                        <button class="btn btn-xs btn-outline-danger" onclick="clearHistory()">Clear History</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive"><table class="table table-sm table-hover mb-0 align-middle">
                            <thead class="table-light"><tr class="small text-muted"><th class="ps-4">Timestamp</th><th>Source</th><th>Status</th><th>Items</th><th class="text-end pe-4">Message</th></tr></thead>
                            <tbody id="historyTableBody" class="small"><tr><td colspan="5" class="text-center py-3">Loading...</td></tr></tbody>
                        </table></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card settings-card shadow-sm h-100 border-0">
                    <div class="card-header bg-white py-3 border-0"><h6 class="fw-bold mb-0 text-dark"><i class="fas fa-calendar-alt me-2 text-info"></i>Scheduled Runs</h6></div>
                    <div class="card-body p-0">
                        <div class="table-responsive"><table class="table table-sm mb-0 align-middle">
                            <tbody class="small">{% if scheduled_jobs %}{% for job in scheduled_jobs %}<tr><td class="ps-3 py-2"><strong>{{ job.name }}</strong><br><span class="text-muted" style="font-size: 0.7em;">{{ job.next_run_time }}</span></td><td class="text-end pe-3 text-primary fw-bold">{{ job.time_until }}</td></tr>{% endfor %}{% endif %}</tbody>
                        </table></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map & Terminal -->
        <div class="row g-4 mb-4">
            <div class="col-md-12"><div class="card settings-card shadow-sm border-0">
                <div class="card-header bg-white py-3 border-0"><h6 class="fw-bold mb-0 text-dark"><i class="fas fa-globe-americas me-2 text-primary"></i>Global Threat Distribution</h6></div>
                <div class="card-body"><div class="row"><div class="col-md-9"><div id="world-map" style="height: 400px; width: 100%;" class="border rounded-3 bg-light"></div></div><div class="col-md-3">
                    <table class="table table-sm border-0"><thead><tr class="small text-muted border-0"><th class="border-0">Country</th><th class="text-end border-0">Count</th></tr></thead><tbody>{% for country in country_stats %}<tr><td class="small py-2">{{ country.country_code }}</td><td class="text-end small py-2 fw-bold text-primary">{{ country.count }}</td></tr>{% endfor %}</tbody></table>
                </div></div></div>
            </div></div>
            <div class="col-md-12"><div class="card settings-card shadow-sm border-0">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-terminal me-2 text-info"></i>Live Operational Logs</h6>
                    <div class="d-flex align-items-center gap-3">
                        <div class="form-check form-switch mb-0"><input class="form-check-input" type="checkbox" id="hidePolls" checked onchange="updateLogs()"><label class="form-check-label small text-muted" for="hidePolls">Hide Polls</label></div>
                        <button class="btn btn-xs btn-outline-secondary" onclick="clearTerminal()">Clear</button>
                    </div>
                </div>
                <div class="card-body pt-0"><div id="logWindow" class="log-window"></div></div>
            </div></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='vendor/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/jsvectormap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/world.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/sweetalert2.all.min.js') }}"></script>
    
    <script>
        window.AppConfig = {
            csrfToken: "{{ csrf_token() }}",
            urls: {
                addSource: "{{ url_for('system.add_source') }}",
                addWhitelist: "{{ url_for('system.add_whitelist') }}"
            },
            sourceUrls: {{ urls|tojson }},
            countryStats: {
                {% for c in country_stats %} "{{ c.country_code }}": {{ c.count }}, {% endfor %}
            },
            flashMessages: [
                {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}
                    {% for category, message in messages %}
                      { category: {{ category|tojson }}, message: {{ message|tojson }} },
                    {% endfor %}
                  {% endif %}
                {% endwith %}
            ]
        };
    </script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>