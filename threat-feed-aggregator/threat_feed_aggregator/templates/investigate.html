{% extends "base.html" %}

{% block title %}Investigate IP{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h3 class="fw-bold text-dark mb-1">Threat Investigation</h3>
            <p class="text-muted small">Real-time IP reputation and geolocation intelligence.</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Search Card -->
        <div class="col-md-5">
            <div class="card settings-card shadow-sm">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-search me-2 text-primary"></i>IP Reputation Query</h6>
                </div>
                <div class="card-body">
                    <form id="investigateForm">
                        <div class="mb-3">
                            <label class="form-label-custom">Target IP Address</label>
                            <div class="input-group shadow-sm">
                                <input type="text" id="ipInput" class="form-control" placeholder="e.g. 8.8.8.8" required>
                                <button class="btn btn-primary px-4" type="submit" id="searchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <hr class="my-4">
                    <div class="small text-muted fw-bold text-uppercase mb-3" style="font-size: 0.65rem; letter-spacing: 0.05em;">Recent Searches</div>
                    <div id="recentSearches" class="d-flex flex-wrap gap-2">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Internal DB Search Card (New) -->
            <div class="card settings-card shadow-sm mt-4">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-database me-2 text-danger"></i>Internal Threat Database</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">Check if an indicator (IP, Domain, URL) exists in your aggregated feeds.</p>
                    <form id="internalSearchForm">
                        <div class="mb-3">
                            <label class="form-label-custom">Indicator</label>
                            <div class="input-group shadow-sm">
                                <input type="text" id="internalInput" class="form-control" placeholder="IP, Domain, or URL" required>
                                <button class="btn btn-danger px-4" type="submit" id="internalSearchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="internalResultArea" class="mt-3 d-none">
                        <label class="form-label-custom">Search Results</label>
                        <div class="p-3 bg-light rounded border">
                            <ul id="internalResultList" class="list-unstyled mb-0 small"></ul>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="small text-muted fw-bold text-uppercase mb-2" style="font-size: 0.65rem; letter-spacing: 0.05em;">Recent Internal Searches</div>
                    <div id="internalRecentSearches" class="d-flex flex-wrap gap-2">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Card -->
        <div class="col-md-7">
            <div id="resultCard" class="card settings-card shadow-sm d-none">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center border-bottom">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-info-circle me-2 text-info"></i>Intelligence Report</h6>
                    <div id="reportIpBadge" class="badge bg-primary px-3"></div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label-custom">Network Intelligence</label>
                            <div class="p-3 bg-light rounded-3 border h-100">
                                <div class="mb-2"><span class="text-muted small">Country:</span> <span id="resCountry" class="fw-bold text-dark">N/A</span> <span id="resFlag"></span></div>
                                <div class="mb-2"><span class="text-muted small">City/Region:</span> <span id="resCity" class="fw-bold text-dark">N/A</span></div>
                                <div class="mb-2"><span class="text-muted small">ISP:</span> <span id="resIsp" class="fw-bold text-dark">N/A</span></div>
                                <div class="mb-2"><span class="text-muted small">ASN:</span> <span id="resAsn" class="fw-bold text-dark">N/A</span></div>
                                <div class="mb-2"><span class="text-muted small">Organization:</span> <span id="resOrg" class="fw-bold text-dark">N/A</span></div>
                                <div id="resMapLink" class="mt-3"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">Reverse DNS / Hosting</label>
                            <div class="p-3 bg-light rounded-3 border h-100">
                                <ul id="resDomains" class="list-unstyled mb-0 small" style="max-height: 200px; overflow-y: auto;">
                                    <li class="text-muted">No domains found.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-12">
                             <label class="form-label-custom">WHOIS Data</label>
                             <pre id="resWhois" class="p-3 bg-dark text-light rounded-3 border small mb-0" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap;">-</pre>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-top">
                        <label class="form-label-custom">External Threat Intelligence</label>
                        <div class="d-flex flex-wrap gap-2">
                            <a id="vtLink" href="#" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas fa-virus me-1"></i>VirusTotal</a>
                            <a id="abuseLink" href="#" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas fa-shield-alt me-1"></i>AbuseIPDB</a>
                            <a id="talosLink" href="#" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas fa-external-link-alt me-1"></i>Cisco Talos</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Placeholder -->
            <div id="noResultPlaceholder" class="card settings-card shadow-sm border-dashed">
                <div class="card-body text-center py-5 text-muted">
                    <i class="fas fa-microscope fa-3x mb-3 opacity-25"></i>
                    <p class="mb-0">Enter a valid IP address to retrieve comprehensive intelligence data.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const investigateForm = document.getElementById('investigateForm');
    const searchBtn = document.getElementById('searchBtn');
    const resultCard = document.getElementById('resultCard');
    const noResultPlaceholder = document.getElementById('noResultPlaceholder');

    // Internal Search Elements
    const internalSearchForm = document.getElementById('internalSearchForm');
    const internalInput = document.getElementById('internalInput');
    const internalSearchBtn = document.getElementById('internalSearchBtn');
    const internalResultArea = document.getElementById('internalResultArea');
    const internalResultList = document.getElementById('internalResultList');

    investigateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const ip = document.getElementById('ipInput').value.trim();
        if (!ip) return;

        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch('/tools/api/lookup_ip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ ip: ip })
        })
            .then(r => r.json())
            .then(data => {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i>';
                
                if (data.success) {
                    noResultPlaceholder.classList.add('d-none');
                    resultCard.classList.remove('d-none');
                    
                    document.getElementById('reportIpBadge').textContent = ip;
                    
                    // Geo Data
                    const geo = data.geo || {};
                    document.getElementById('resCountry').textContent = geo.country || 'Unknown';
                    document.getElementById('resCity').textContent = `${geo.city || '-'}, ${geo.regionName || '-'}`;
                    document.getElementById('resIsp').textContent = geo.isp || 'Unknown';
                    document.getElementById('resAsn').textContent = geo.as || 'Unknown';
                    document.getElementById('resOrg').textContent = geo.org || 'Unknown';
                    
                    // Hosting Data (from THC or others)
                    const domainsList = document.getElementById('resDomains');
                    domainsList.innerHTML = '';
                    const domains = (data.data && data.data.domains) ? data.data.domains : [];
                    
                    if (domains.length > 0) {
                        domains.forEach(d => {
                            const li = document.createElement('li');
                            li.className = 'mb-1 fw-bold text-dark';
                            // Handle both object (THC API) and string (Legacy/Other) formats
                            li.textContent = (typeof d === 'object' && d.domain) ? d.domain : d;
                            domainsList.appendChild(li);
                        });
                    } else {
                        domainsList.innerHTML = '<li class="text-muted">No associated domains found.</li>';
                    }
                    
                    // WHOIS
                    document.getElementById('resWhois').textContent = data.whois_data || 'No WHOIS record.';

                    document.getElementById('resMapLink').innerHTML = `<a href="https://www.google.com/maps/search/?api=1&query=${geo.lat || ip},${geo.lon || ''}" target="_blank" class="btn btn-sm btn-outline-primary w-100"><i class="fas fa-map me-2"></i>View on Map</a>`;
                    document.getElementById('vtLink').href = `https://www.virustotal.com/gui/ip-address/${ip}`;
                    document.getElementById('abuseLink').href = `https://www.abuseipdb.com/check/${ip}`;
                    document.getElementById('talosLink').href = `https://talosintelligence.com/reputation_center/lookup?search=${ip}`;
                    
                    saveRecentSearch(ip);
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(err => {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i>';
                Swal.fire('Error', 'Service unreachable.', 'error');
            });
    });

    internalSearchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const indicator = internalInput.value.trim();
        if (!indicator) return;

        internalSearchBtn.disabled = true;
        internalSearchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        internalResultArea.classList.add('d-none');

        fetch('/tools/api/lookup_internal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ indicator: indicator })
        })
        .then(r => r.json())
        .then(data => {
            internalSearchBtn.disabled = false;
            internalSearchBtn.innerHTML = '<i class="fas fa-search"></i>';

            if (data.success) {
                internalResultList.innerHTML = '';
                const sources = data.sources || [];
                
                if (sources.length > 0) {
                    sources.forEach(src => {
                        const li = document.createElement('li');
                        li.className = 'mb-2 text-dark';
                        li.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-2"></i><strong>${src.source_name}</strong><br><small class="text-muted ms-4">Last seen: ${src.last_seen}</small>`;
                        internalResultList.appendChild(li);
                    });
                } else {
                    internalResultList.innerHTML = '<li class="text-success"><i class="fas fa-check-circle me-2"></i>Not found in any internal threat feed.</li>';
                }
                internalResultArea.classList.remove('d-none');
                saveRecentInternalSearch(indicator);
            } else {
                Swal.fire('Error', data.error, 'error');
            }
        })
        .catch(err => {
            internalSearchBtn.disabled = false;
            internalSearchBtn.innerHTML = '<i class="fas fa-search"></i>';
            Swal.fire('Error', 'Service unreachable.', 'error');
        });
    });

    function saveRecentSearch(ip) {
        let history = JSON.parse(localStorage.getItem('recentIps') || '[]');
        if (!history.includes(ip)) {
            history.unshift(ip); if (history.length > 6) history.pop();
            localStorage.setItem('recentIps', JSON.stringify(history));
            updateRecentSearches();
        }
    }

    function updateRecentSearches() {
        const container = document.getElementById('recentSearches');
        const history = JSON.parse(localStorage.getItem('recentIps') || '[]');
        container.innerHTML = history.length ? '' : '<span class="text-muted small">No recent history.</span>';
        history.forEach(ip => {
            const span = document.createElement('span');
            span.className = 'badge bg-light text-dark border px-2 py-2 cursor-pointer';
            span.style.cursor = 'pointer';
            span.textContent = ip;
            span.onclick = () => { document.getElementById('ipInput').value = ip; investigateForm.dispatchEvent(new Event('submit')); };
            container.appendChild(span);
        });
    }

    function saveRecentInternalSearch(term) {
        let history = JSON.parse(localStorage.getItem('recentInternal') || '[]');
        // Remove if exists to bubble to top
        history = history.filter(item => item !== term);
        history.unshift(term); 
        if (history.length > 6) history.pop();
        localStorage.setItem('recentInternal', JSON.stringify(history));
        updateRecentInternalSearches();
    }

    function updateRecentInternalSearches() {
        const container = document.getElementById('internalRecentSearches');
        const history = JSON.parse(localStorage.getItem('recentInternal') || '[]');
        container.innerHTML = history.length ? '' : '<span class="text-muted small">No recent history.</span>';
        history.forEach(term => {
            const span = document.createElement('span');
            span.className = 'badge bg-soft-danger text-danger border border-danger px-2 py-2 cursor-pointer';
            span.style.cursor = 'pointer';
            span.textContent = term;
            span.onclick = () => { document.getElementById('internalInput').value = term; internalSearchForm.dispatchEvent(new Event('submit')); };
            container.appendChild(span);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateRecentSearches();
        updateRecentInternalSearches();
    });
</script>
{% endblock %}