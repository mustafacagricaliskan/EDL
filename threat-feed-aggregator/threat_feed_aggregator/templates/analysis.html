{% extends "base.html" %}

{% block title %}Threat Analysis Center{% endblock %}

{% block extra_head %}
<style>
    /* Filter Bar Styles similar to FortiGate */
    .filter-bar {
        background-color: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        min-height: 46px;
    }
    .filter-chip {
        background-color: #f1f5f9;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        color: #334155;
        font-weight: 500;
    }
    .filter-chip .key {
        color: #64748b;
        margin-right: 4px;
        text-transform: uppercase;
        font-size: 0.7rem;
        font-weight: 700;
    }
    .filter-chip .value {
        margin-right: 6px;
    }
    .filter-chip .remove {
        cursor: pointer;
        color: #94a3b8;
        font-size: 1rem;
        line-height: 1;
    }
    .filter-chip .remove:hover { color: #ef4444; }
    
    .add-filter-btn {
        border: 1px dashed #cbd5e1;
        color: #64748b;
        background: transparent;
        padding: 4px 10px;
        font-size: 0.8rem;
        border-radius: 4px;
        transition: all 0.2s;
    }
    .add-filter-btn:hover {
        background: #f8fafc;
        border-color: #94a3b8;
        color: #334155;
    }

    /* Popover Styling for Filter Menu */
    .filter-menu {
        min-width: 250px;
        padding: 10px;
    }
    .filter-menu label { font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 4px; display: block; }
    .filter-menu select, .filter-menu input { margin-bottom: 10px; font-size: 0.85rem; }

    /* Fix DataTables length menu dropdown arrow overlap */
    .dataTables_length select.form-select {
        padding-right: 2.5rem !important;
        min-width: 70px !important;
        display: inline-block;
        width: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h3 class="fw-bold text-dark mb-1">Threat Analysis Center</h3>
            <p class="text-muted small">Deep dive into aggregated threat indicators, risk scores, and attribution.</p>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="mb-3">
        <div class="filter-bar" id="filterContainer">
            <!-- Filter Chips will be inserted here -->
            
            <div class="dropdown">
                <button class="add-filter-btn dropdown-toggle" type="button" id="addFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-plus me-1"></i> Add Filter
                </button>
                <div class="dropdown-menu shadow p-3 filter-menu" aria-labelledby="addFilterDropdown">
                    <label>Filter Type</label>
                    <select id="newFilterType" class="form-select form-select-sm">
                        <option value="source">Source Name</option>
                        <option value="tag">Tag (Botnet, Malware...)</option>
                        <option value="type">Indicator Type</option>
                        <option value="level">Risk Level</option>
                        <option value="country">Country Code</option>
                        <option value="risk_score">Risk Score (Threshold)</option>
                    </select>
                    
                    <label id="valueLabel">Value</label>
                    <input type="text" id="newFilterValue" class="form-control form-control-sm" placeholder="Type or select..." list="filterOptionsList" autocomplete="off">
                    <datalist id="filterOptionsList">
                        <!-- Populated by JS -->
                    </datalist>
                    
                    <div class="d-grid mt-2">
                        <button class="btn btn-sm btn-primary" onclick="addFilter()">Apply</button>
                    </div>
                </div>
            </div>
            
            <!-- Clear All -->
            <button class="btn btn-link text-muted text-decoration-none btn-sm ms-auto" style="font-size: 0.8rem;" onclick="clearAllFilters()">Clear All</button>
        </div>
    </div>

    <div class="card settings-card shadow-sm border-0">
        <div class="card-body">
            <div class="table-responsive">
                <table id="analysisTable" class="table table-hover align-middle w-100">
                    <thead class="bg-light">
                        <tr class="small text-muted text-uppercase">
                            <th>Indicator</th>
                            <th>Type</th>
                            <th>Country</th>
                            <th>Score</th>
                            <th>Level</th>
                            <th>Sources</th>
                            <th>Tags</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody class="small">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let activeFilters = [];
    let table;

    $(document).ready(function() {
        table = $('#analysisTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{{ url_for('analysis.data') }}",
                data: function(d) {
                    // Inject active filters into the request
                    // We map them to specific column searches expected by backend logic or custom params
                    // Current backend expects: columns[i][search][value]
                    // Column Map: 1:Type, 2:Country, 4:Level
                    // For Source/Tag/RiskScore, we need to pass them as custom params or map to dummy columns?
                    // The backend code I wrote supports `filters` dict if passed via logic, 
                    // BUT `routes/analysis.py` extracts them from `columns[i][search][value]`.
                    
                    // To support Source and Tag, I need to update routes/analysis.py to look for them.
                    // Or I can overload the 'search' parameter, but that's messy.
                    
                    // Best way: Pass 'custom_filters' as a JSON string in the request
                    let filterDict = {};
                    activeFilters.forEach(f => {
                        filterDict[f.type] = f.value;
                    });
                    d.custom_filters = JSON.stringify(filterDict);
                }
            },
            columns: [
                { data: 'indicator', render: function(data) { return `<span class="fw-bold text-dark">${data}</span>`; }},
                { data: 'type', render: function(data) {
                    let color = 'secondary';
                    if(data === 'ip' || data === 'cidr') color = 'info'; else if(data === 'domain') color = 'warning'; else if(data === 'url') color = 'primary';
                    return `<span class="badge bg-soft-${color} text-${color} text-uppercase" style="font-size:0.65rem;">${data}</span>`;
                }},
                { data: 'country', render: function(data) { return data ? `<span class="badge bg-light text-dark border">${data}</span>` : '-'; }},
                { data: 'risk_score', render: function(data) {
                    let color = 'success';
                    if(data >= 90) color = 'danger'; else if(data >= 70) color = 'warning'; else if(data >= 40) color = 'primary';
                    return `<div class="progress" style="height: 6px; width: 60px;" title="${data}"><div class="progress-bar bg-${color}" role="progressbar" style="width: ${data}%"></div></div><small class="text-muted" style="font-size:0.7em;">${data}/100</small>`;
                }},
                { data: 'level', render: function(data) {
                    let color = 'secondary';
                    if(data === 'Critical') color = 'danger'; else if(data === 'High') color = 'warning'; else if(data === 'Medium') color = 'primary'; else if(data === 'Low') color = 'success';
                    return `<span class="badge bg-${color}">${data}</span>`;
                }},
                { data: 'sources', render: function(data) { return `<span class="text-muted" style="font-size:0.75rem;">${data}</span>`; }},
                { data: 'tags', render: function(data) {
                    return data.map(tag => {
                        let color = 'secondary';
                        if(tag.includes('Malware') || tag.includes('Botnet')) color = 'danger'; else if(tag.includes('Phishing')) color = 'warning';
                        return `<span class="badge bg-soft-${color} text-${color} me-1" style="font-size:0.65rem;">${tag}</span>`;
                    }).join('');
                }},
                { data: 'last_seen', render: function(data) { return data ? data.replace('T', ' ').substring(0, 16) : '-'; }}
            ],
            order: [[3, 'desc']],
            language: { search: "", searchPlaceholder: "Global search..." },
            dom: '<"d-flex justify-content-between align-items-center mb-3"f>rt<"d-flex justify-content-between align-items-center mt-3"lip>'
        });

        // Dynamic Input Logic (Autocomplete)
        const filterTypeSelect = $('#newFilterType');
        const filterValueInput = $('#newFilterValue');
        const dataList = $('#filterOptionsList');
        let debounceTimer;

        function fetchOptions(query) {
            const col = filterTypeSelect.val();
            if (col === 'risk_score') return; // No autocomplete for numbers

            fetch(`{{ url_for('analysis.filter_options') }}?column=${col}&q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    dataList.empty();
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        dataList.append(option);
                    });
                });
        }

        // Fetch on Type Change (Initial list)
        filterTypeSelect.change(function() {
            filterValueInput.val('');
            const type = $(this).val();
            
            if (type === 'risk_score') {
                filterValueInput.attr('placeholder', 'e.g. 80 (means >= 80)');
                filterValueInput.attr('type', 'number'); // Force number input
                filterValueInput.attr('list', ''); // Disable datalist
            } else {
                filterValueInput.attr('placeholder', 'Type or select...');
                filterValueInput.attr('type', 'text');
                filterValueInput.attr('list', 'filterOptionsList');
                fetchOptions('');
            }
        });

        // Fetch on Typing (Debounced)
        filterValueInput.on('input', function() {
            const query = this.value;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetchOptions(query);
            }, 300);
        });
        
        // Initial Fetch
        fetchOptions('');
    });

    function addFilter() {
        const type = $('#newFilterType').val();
        const val = $('#newFilterValue').val().trim();

        if (!val) return;

        // Check duplicates
        if (activeFilters.some(f => f.type === type)) {
            // Update existing
            activeFilters = activeFilters.map(f => f.type === type ? {type, value: val} : f);
        } else {
            activeFilters.push({ type, value: val });
        }

        renderFilters();
        table.ajax.reload();
        
        // Hide dropdown
        $('[data-bs-toggle="dropdown"]').dropdown('hide');
    }

    function removeFilter(type) {
        activeFilters = activeFilters.filter(f => f.type !== type);
        renderFilters();
        table.ajax.reload();
    }

    function clearAllFilters() {
        activeFilters = [];
        renderFilters();
        table.ajax.reload();
    }

    function renderFilters() {
        const container = $('#filterContainer');
        // Keep the dropdown and clear buttons, remove chips
        container.find('.filter-chip').remove();
        
        activeFilters.forEach(f => {
            const chip = `
                <div class="filter-chip" title="Click to edit">
                    <span class="key">${f.type}:</span>
                    <span class="value" onclick="editFilter('${f.type}', '${f.value.replace(/'/g, "\\'")}')" style="cursor:pointer; border-bottom:1px dotted #ccc;">${f.value}</span>
                    <span class="remove" onclick="removeFilter('${f.type}')">&times;</span>
                </div>
            `;
            $(chip).insertBefore(container.find('.dropdown'));
        });
    }

    function editFilter(type, value) {
        // Set values in dropdown
        $('#newFilterType').val(type).trigger('change');
        
        // Wait for change handler to adjust inputs
        setTimeout(() => {
            if (type === 'type' || type === 'level') {
                $('#newFilterValueSelect').val(value);
            } else {
                $('#newFilterValue').val(value);
            }
            // Show dropdown
            const dropdownToggle = document.getElementById('addFilterDropdown');
            new bootstrap.Dropdown(dropdownToggle).show();
        }, 50);
    }
</script>
{% endblock %}